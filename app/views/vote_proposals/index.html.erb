<% content_for :header do %>
  <%= render partial: "header" %>
<% end %>
  
<!-- Main -->
<div id="main" style="margin-top:2em">
  <%= will_paginate @vote_proposals %>
  <div class="inner">
    <div class="columns">

      <% @vote_proposals.each do |vp| %>
        <div class="image fit">        
<%
   p_ind= @vote_proposals.index(vp) - 1 
   n_ind = @vote_proposals.index(vp) + 1
   p_ind = p_ind < 0 ? 0 : p_ind
   n_ind = n_ind > (@vote_proposals.size - 1) ? (@vote_proposals.size - 1) : n_ind
   n_vp = @vote_proposals[n_ind]
   p_vp = @vote_proposals[p_ind]
%>
          <article style="border:1px dotted #ddd; padding: 8px;">
            <header><%= link_to vp.topic, vote_proposal_path(vp) %></header>
            <table>
              <tr><td>Nimi</td><td>Anonyymi</td><td>Vahvistettu</td></tr>
              <tr>
              <% vp.vote_proposal_options.each do |option|
                record = vp.find_counter_cache_record(option)
                css_class = "button small red"
                 vote = @votes[vp.id]
                 if vote
                  ind = vote.vote_proposal_options.index(option)
                  if ind && (ind >= 0)
                    css_class += " voted"
                    par = {
                      vote: { vote_proposal_options_attributes: [{id: option.id, _destroy: true}] }
                    }
                  else
                    par = { vote: { vote_proposal_option_ids: [option.id] } }
                  end
                 %>
                 <td><%= link_to option.name, update_vote_path(vote, par), remote: true, method: :put, class: "#{css_class}" %></td>
                <% else
                  par = {
                     vote: {
                       vote_proposal_id: vp.id,
                       vote_proposal_option_ids: [option.id]
                     }
                  } %>
                  <td><%= link_to option.name, create_vote_path(par), remote: true, method: :post, class: "#{css_class}" %></td>
                  
              <% end %>
                <td><%= record.anonymous_vote_count %></td>
                <td><%= record.confirmed_vote_count %></td>
              </tr>
              <% end %>
            </table>
          </article>
        </div>
      <% end %>

    </div>
  </div>
  <%= will_paginate @vote_proposals %>
</div>

